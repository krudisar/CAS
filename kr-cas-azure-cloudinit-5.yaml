formatVersion: 1
inputs:
  platform:
    type: string
    title: Select Platform
    default: 'platform:azure'
    oneOf:
      - title: Amazon Web Services
        const: 'platform:aws'
      - title: Microsoft Azure
        const: 'platform:azure'
  tshirtsize:
    type: string
    title: Select Machine Size
    default: small
    oneOf:
      - title: Small
        const: small
      - title: Medium
        const: medium
  vm_host_name:
    type: string
    default: test-hostname.demo
    description: Enter custom hostname - DO NOT use underscore in custom name string !!!
    title: Custom Name
    pattern: '^[a-zA-Z0-9.-]*$' # validation pattern for custom name - allowed characters -> a-z A-Z 0-9 . (dot) - (dash) 
resources:
  webserver_machine_1:
    type: Cloud.Machine
    dependsOn:
      - database_machine_1
    metadata:
      layoutPosition:
        - 0
        - 0
    properties:
      image: ubuntu
      flavor: '${input.tshirtsize}'
      insert: property
      constraints:
        - tag: '${input.platform}'
      cloudConfig: |
        #cloud-config
        # hostname: custom-name
        hostname: '${input.vm_host_name}'
        users:
          - name: demo
            ssh-authorized-keys:
              - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSX9jYx5ReAxPFrca0cD1Qp+DPWRQdWU/nZmAWvG7ONHCCcGZAll4mukOtwvT3P31b2SvWeUQgJ9DMOwgs7QphfgBz1tg6pQ2A0eUq+74VxRDF4PTPIpnzFvcAv+v+zYv3bt53uuj0Yu2SNRsYovCM6iNfvapMaVyEgl1awlhU3Os3axytKhsoL4QQQR8Xqk2VE7SrA746tzglo+5hrzNtZIgxIDnEPQIspdDPnjSw6tLV2RfjiHhuAztaRsa4qwOcq905kSRiegISGlRGyBMGhMuRq5fAKtBF+0apyeAxC/QNpypnjWSAYzz6Q6wJWetVDEv1FVQUVjrin0YxZsVV krudisar@krudisar-macbook.local
              - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDBhKIIRvQgbuCv5RGPSsqZrTp+hqNzei6VJdWGmSq+WuzM177x7f6Ba6Lr407x309EMMSX1NuwwustxGfUKow0PbZZRYkM+CltqKPV/XeGx2ACLDlgWG9x7vB7rIl5EcgbnoXX3Xh8/kECK/1shoWBOzYGYsTAfozOIHrMe6JH+coCSen0BdATTimzFa+Gg9FlTQaXBjNww1TolfcbvPHxXF+OuX4dx5Hf9S6jp4+w79PMPdyMep89ESnC8+PSM8dnfJXU2ucvIo0CjnIBZuVVx9TUIFB48L5EvPDvpl90edFwlrdHTEApijTXqQhN36TWPvMEoT3h166wN4jAr5Q1 krudisar@krudisar-devbox
            sudo: ['ALL=(ALL) NOPASSWD:ALL']
            groups: sudo
            shell: /bin/bash
        package_upgrade: true
        packages:
          - nginx
          - nodejs
          - npm
        write_files:
          - owner: www-data:www-data
            path: /etc/nginx/sites-available/default
            content: |
              server {
                listen 80;
                location / {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection keep-alive;
                  proxy_set_header Host $host;
                  proxy_cache_bypass $http_upgrade;
                }
              }
          - owner: azureuser:azureuser
            path: /home/azureuser/myapp/index.js
            content: |
              var express = require('express')
              var app = express()
              var os = require('os');
              app.get('/', function (req, res) {
                res.send('Wow! Hello World from host ' + os.hostname() + 'Database Server Name:' + '${resource.database_machine_1.name}' + ' IP: ' + '${resource.database_machine_1.networks.address}')
              })
              app.listen(3000, function () {
                console.log('Hello world app listening on port 3000!')
              })
        runcmd:
          - service nginx restart
          - cd "/home/azureuser/myapp"
          - npm init
          - npm install express -y
          - nodejs index.js
          - sed -i -e '/^Port/s/^.*$/Port 4444/' /etc/ssh/sshd_config
          - sed -i -e '/^PermitRootLogin/s/^.*$/PermitRootLogin no/' /etc/ssh/sshd_config
          - sed -i -e '$aAllowUsers demo' /etc/ssh/sshd_config
          - restart ssh
  database_machine_1:
    type: Cloud.Machine
    metadata:
      layoutPosition:
        - 0
        - 1
    properties:
      image: ubuntu
      flavor: medium
      insert: property
      constraints:
        - tag: '${input.platform}'
      cloudConfig: |
        #cloud-config
        # hostname: custom-name
        hostname: 'dbserver'
        users:
          - name: demo
            ssh-authorized-keys:
              - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSX9jYx5ReAxPFrca0cD1Qp+DPWRQdWU/nZmAWvG7ONHCCcGZAll4mukOtwvT3P31b2SvWeUQgJ9DMOwgs7QphfgBz1tg6pQ2A0eUq+74VxRDF4PTPIpnzFvcAv+v+zYv3bt53uuj0Yu2SNRsYovCM6iNfvapMaVyEgl1awlhU3Os3axytKhsoL4QQQR8Xqk2VE7SrA746tzglo+5hrzNtZIgxIDnEPQIspdDPnjSw6tLV2RfjiHhuAztaRsa4qwOcq905kSRiegISGlRGyBMGhMuRq5fAKtBF+0apyeAxC/QNpypnjWSAYzz6Q6wJWetVDEv1FVQUVjrin0YxZsVV krudisar@krudisar-macbook.local
              - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDBhKIIRvQgbuCv5RGPSsqZrTp+hqNzei6VJdWGmSq+WuzM177x7f6Ba6Lr407x309EMMSX1NuwwustxGfUKow0PbZZRYkM+CltqKPV/XeGx2ACLDlgWG9x7vB7rIl5EcgbnoXX3Xh8/kECK/1shoWBOzYGYsTAfozOIHrMe6JH+coCSen0BdATTimzFa+Gg9FlTQaXBjNww1TolfcbvPHxXF+OuX4dx5Hf9S6jp4+w79PMPdyMep89ESnC8+PSM8dnfJXU2ucvIo0CjnIBZuVVx9TUIFB48L5EvPDvpl90edFwlrdHTEApijTXqQhN36TWPvMEoT3h166wN4jAr5Q1 krudisar@krudisar-devbox
            sudo: ['ALL=(ALL) NOPASSWD:ALL']
            groups: sudo
            shell: /bin/bash
        package_upgrade: true
